<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restoring Kitengela: Reforestation Story</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <link href="/static/css/styles.css" rel="stylesheet">
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="container">
        <h1>Restoring Kitengela: A Path to Reforestation</h1>
        <p>Learn how we can transform the land and restore hope through reforestation. Together, we can create a sustainable future.</p>
      </div>
    </header>

    <!-- Section 1: How We Got Here -->
    <section class="section">
      <div class="container">
        <h2 class="section-heading">How We Got Here</h2>
        <div class="row align-items-center">
          <div class="col-md-6">
            <p class="content-text">Our land was once fertile and rich, but years of deforestation, overgrazing, and environmental neglect have led to soil erosion, loss of biodiversity, and a drier climate. This has affected our ability to grow food and access water, threatening the survival of communities.</p>
          </div>
          <div class="col-md-6">
            <img src="/static/img/past-kitengela.webp" alt="Fertile land in the past" class="story-image">
          </div>
        </div>
      </div>
    </section>

    <!-- Section 2: The Consequences of Inaction -->
    <section class="section bg-light">
      <div class="container">
        <h2 class="section-heading">The Consequences of Inaction</h2>
        <div class="row align-items-center">
          <div class="col-md-6">
            <img src="/static/img/present-kitengela.webp" alt="Barren landscape" class="story-image">
          </div>
          <div class="col-md-6">
            <p class="content-text">If we do nothing, the land will continue to degrade, leading to the permanent loss of vegetation, water scarcity, and uninhabitable conditions. The consequences will be felt not only by the current generation but by generations to come.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Section 3: The Hope of Action -->
    <section class="section">
      <div class="container">
        <h2 class="section-heading">The Hope of Action</h2>
        <div class="row align-items-center">
          <div class="col-md-6">
            <p class="content-text">When we take action by planting trees, we restore life to the land. Trees help retain moisture, improve soil quality, and attract rainfall. They also support biodiversity and provide shade, cooling the local climate.</p>
          </div>
          <div class="col-md-6">
            <img src="/static/img/plant.jpeg" alt="Forest landscape" class="story-image">
          </div>
        </div>
      </div>
    </section>

    <!-- Section 4: The Science of Reforestation -->
    <section class="section bg-light">
      <div class="container">
        <h2 class="section-heading">The Science Behind It</h2>
        <blockquote class="quote">"A single tree can cool the air, improve soil fertility, and increase rainfall in a region. We have the power to transform the environment with reforestation."</blockquote>
        <p class="content-text text-center">Reforestation is not just about planting trees. It's about understanding the right trees for the right conditions. By choosing drought-resistant species, we can create long-term, sustainable impact in Kitengela.</p>
        <div class="row">
          <div class="col-md-12">
            <img src="/static/img/kakamega.gif" alt="Forest landscape" class="story-image">
          </div>
        </div>
      </div>
    </section>

    <!-- Section 5: Map Comparisons -->
    <section class="comparison-section">
      <div class="container">
        <h2 class="section-heading text-center">How Our Things Have Changed</h2>
        <div class="container mb-5">
          <h3 class="text-center mb-4 custom-heading">Vegetation Distribution</h3>
          <div class="iframe-container">
            <iframe src="https://livingatlas.arcgis.com/landcoverexplorer/#mapCenter=38.35282%2C0.62418%2C4.924370935066931&mode=step&timeExtent=2017%2C2021&year=2022" allowfullscreen></iframe>
          </div>
        </div>

        <div class="container mb-5">
          <div class="row">
            <div class="col-md-12">
              <div class="card custom-card pt-3">
                <div class="card-body">
                  <h3 class="text-center mb-4 custom-heading">Climate Data Comparison (Rainfall & Temperature)</h3>
                  <div class="text-center years-div">
                  </div>
                  <div class="chart-wrapper d-flex">
                    <div class="chart-container">
                      <canvas id="climateChart"></canvas>
                    </div>
                    <div id="legend" class="legend-container ml-3"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <h3 class="text-center mb-4 custom-heading">Weather Data Overview</h3>
        <div class="table-responsive">
          <table class="table table-bordered table-custom">
            <thead>
              <tr>
                <th><i class="fas fa-calendar-alt"></i> Year</th>
                <th><i class="fas fa-cloud-rain"></i> Total Rainfall (mm)</th>
                <th><i class="fas fa-thermometer-half"></i> Avg Temperature (°C)</th>
                <th><i class="fas fa-star"></i> Rating</th>
                <th><i class="fas fa-arrow-up"></i> Highest Monthly Rainfall</th>
                <th><i class="fas fa-arrow-up"></i> Highest Monthly Temperature</th>
                <th><i class="fas fa-arrow-down"></i> Lowest Monthly Rainfall</th>
                <th><i class="fas fa-arrow-down"></i> Lowest Monthly Temperature</th>
              </tr>
            </thead>
            <tbody id="summaryTableBody">
            </tbody>
          </table>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="card custom-card" style="height: 300px;">
              <div class="card-body">
                <h5 class="text-center">Total Rainfall (mm)</h5>
                <div class="chart-container">
                  <canvas id="rainfallChart"></canvas>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card custom-card" style="height: 300px;">
              <div class="card-body">
                <h5 class="text-center">Average Temperature (°C)</h5>
                <div class="chart-container">
                  <canvas id="temperatureChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="mt-5">
      <div class="container">
        <h2 class="section-heading">Suitable Plants to Grow</h2>
        <div class="row justify-content-center" id="plant-data">
          <!-- Plant cards will be inserted here -->
        </div>
      </div>
    </section>

    <!-- Section 6: Call to Action -->
    <section class="call-to-action">
      <div class="container">
        <h2>Join the Movement to Reforest Kitengela</h2>
        <p>Let's come together and make a difference. Every tree planted is
        a step towards restoring our land and securing a future for our communities. Be part of the solution today.</p>
        <a href="#contact" class="btn btn-main">Get Involved</a>
      </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <p>&copy; 2024 Greenbelt Movement. All rights reserved. | Designed with care for Kitengela and beyond.</p>
      </div>
    </footer>

    <!-- Optional JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let climateData = null;
      // Fetch climate data from Flask endpoint
      async function fetchClimateData() {
              try {
                      const response = await fetch('/climate_data');
                      climateData = await response.json();

                      // Call function to create year toggle buttons dynamically
                      createYearButtons(climateData);

                      // Call the function to update the table
                      updateSummaryTable(climateData);

                      // Other graphs
                      otherGraphs(climateData);

                    } catch (error) {
                            console.error('Error fetching climate data:', error);
                          }
            }

      // Dynamically create year toggle buttons
      function createYearButtons(climateData) {
              const yearButtonsDiv = document.querySelector('.years-div');
              yearButtonsDiv.innerHTML = ''; // Clear existing buttons

              for (const year in climateData) {
                      const button = document.createElement('button');
                      button.classList.add('year-toggle');
                      button.textContent = year;
                      button.setAttribute('data-year', year);
                      button.onclick = () => toggleYear(year);
                      yearButtonsDiv.appendChild(button);
                    }
            }

      async function fetchPlantData() {
              try {
                      const response = await fetch("http://127.0.0.1:5000/api/plants?climate_zone=temperate&latitude=34.0522&longitude=-118.2437");

                      if (!response.ok) {
                              throw new Error(`HTTP error! status: ${response.status}`);
                            }

                      const data = await response.json();
                      displayPlants(data.data);
                    } catch (error) {
                            console.error('Error fetching plant data:', error);
                          }
            }

      function displayPlants(plants) {
              const plantDataContainer = document.getElementById('plant-data');
              plantDataContainer.innerHTML = ''; // Clear existing data

              plants.forEach(plant => {
                      const imageUrl = plant.image_url || 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSWQwE9uVmHAYj0cF7B0tg9140LPsKCEh4GpA&s'; // Placeholder image
                      const plantCard = `
     <div class="col-md-4">
     <div class="card">
     <img src="${imageUrl}" class="card-img-top" alt="${plant.common_name}" onerror="this.onerror=null; this.src='https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSWQwE9uVmHAYj0cF7B0tg9140LPsKCEh4GpA&s'">
     <div class="card-body">
     <h5 class="card-title">${plant.common_name}</h5>
     <p class="card-text"><strong>Scientific Name:</strong> ${plant.scientific_name}</p>
     </div>
     </div>
     </div>
     `;
                      plantDataContainer.innerHTML += plantCard; // Append new card
                    });
            }

      fetchPlantData();
      fetchClimateData();

      let ctx = document.getElementById('climateChart').getContext('2d');
      let climateChart = new Chart(ctx, {
              type: 'bar',
              data: {
                      labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                      datasets: []
                    },
              options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      scales: {
                              'y-axis-1': {
                                      type: 'linear',
                                      position: 'left',
                                      title: {
                                              display: true,
                                              text: 'Rainfall (mm)',
                                              font: { weight: 'bold' },
                                            }
                                    },
                              'y-axis-2': {
                                      type: 'linear',
                                      position: 'right',
                                      grid: { drawOnChartArea: false },
                                      title: {
                                              display: true,
                                              text: 'Temperature (°C)',
                                              font: { weight: 'bold' },
                                            }
                                    },
                              x: {
                                      type: 'category',
                                      labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
                                    }
                            },
                      plugins: {
                              zoom: {
                                      pan: {
                                              enabled: true,
                                              mode: 'xy'
                                            },
                                      zoom: {
                                              wheel: { enabled: true },
                                              pinch: { enabled: true },
                                              drag: { enabled: false },
                                              mode: 'xy'
                                            }
                                    }
                            },
                      tooltips: {
                              mode: 'index',
                              intersect: false
                            },
                      legend: {
                              display: true,
                              position: 'top'
                            }
                    }
            });

      // Function to toggle year data in the chart
      function toggleYear(year) {
              const datasetExists = climateChart.data.datasets.some(dataset => dataset.label.includes(year));

              // Toggle button active state
              const buttons = document.querySelectorAll('.year-toggle');
              buttons.forEach(button => {
                      if (button.getAttribute('data-year') === year) {
                              button.classList.toggle('active');
                            } else {
                                    button.classList.remove('active');
                                  }
                    });

              if (datasetExists) {
                      // Remove the datasets for the selected year
                      climateChart.data.datasets = climateChart.data.datasets.filter(dataset => !dataset.label.includes(year));
                    } else {
                            // Add the datasets for the selected year
                            const data = climateData[year];

                            // Create dataset for rainfall (bar chart)
                            let rainDataset = {
                                    label: `Rainfall ${year}`,
                                    data: data.rainfall,
                                    backgroundColor: getRandomColor(),
                                    yAxisID: 'y-axis-1',
                                    type: 'bar'
                                  };

                            // Create dataset for temperature (line chart)
                            let tempDataset = {
                                    label: `Temperature ${year}`,
                                    data: data.temperature,
                                    borderColor: getRandomColor(),
                                    yAxisID: 'y-axis-2',
                                    fill: false,
                                    type: 'line',
                                    tension: 0.5,
                                  };

                            climateChart.data.datasets.push(rainDataset, tempDataset);
                          }

              climateChart.update();
              updateLegend();
            }

      // Function to get the highest value and its month
      function getHighest(arr) {
              const maxValue = Math.max(...arr);
              const month = arr.indexOf(maxValue);
              return { value: maxValue, month: month + 1 }; // Months are 1-indexed
            }

      // Function to get the lowest value and its month
      function getLowest(arr) {
              const minValue = Math.min(...arr);
              const month = arr.indexOf(minValue);
              return { value: minValue, month: month + 1 }; // Months are 1-indexed
            }

      // Function to determine rating based on average temperature and total rainfall
      function getRating(avgTemp, totalRainfall) {
              if (avgTemp > 25 || totalRainfall > 800) return 'High';
              if (avgTemp < 15 || totalRainfall < 400) return 'Low';
              return 'Moderate';
            }

      // Function to update summary table
      function updateSummaryTable(climateData) {
              const summaryTableBody = document.getElementById('summaryTableBody');
              summaryTableBody.innerHTML = '';

              for (const year in climateData) {
                      const data = climateData[year];

                      // Calculate necessary values
                      const avgTemp = average(data.temperature).toFixed(2);
                      const totalRainfall = data.rainfall.reduce((a, b) => a + b, 0).toFixed(2);
                      const rating = getRating(avgTemp, totalRainfall);

                      const highestRainfall = getHighest(data.rainfall);
                      const highestTemp = getHighest(data.temperature);
                      const lowestRainfall = getLowest(data.rainfall);
                      const lowestTemp = getLowest(data.temperature);

                      // Create a new row and fill in the table data
                      const row = document.createElement('tr');
                      row.innerHTML = `
     <td>${year}</td>
     <td class="rain-cell">${totalRainfall} mm</td>
     <td class="temp-cell">${avgTemp} °C</td>
     <td class="rating-${rating.toLowerCase()}">${rating}</td>
     <td>${getMonthName(highestRainfall.month)} (${highestRainfall.value} mm)</td>
     <td>${getMonthName(highestTemp.month)} (${highestTemp.value} °C)</td>
     <td>${getMonthName(lowestRainfall.month)} (${lowestRainfall.value} mm)</td>
     <td>${getMonthName(lowestTemp.month)} (${lowestTemp.value} °C)</td>
     `;

                      summaryTableBody.appendChild(row);
                    }
            }

      // Helper function to convert month number to name
      function getMonthName(monthIndex) {
              const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
              return monthNames[monthIndex - 1];
            }

      // Function to update the legend dynamically
      function updateLegend() {
              const legendContainer = document.getElementById('legend');
              legendContainer.innerHTML = '';

              climateChart.data.datasets.forEach(dataset => {
                      const legendItem = document.createElement('div');
                      legendItem.className = 'legend-item';

                      const colorBox = document.createElement('span');
                      colorBox.className = 'legend-color';
                      colorBox.style.backgroundColor = dataset.type === 'bar' ? dataset.backgroundColor : dataset.borderColor;

                      const label = document.createElement('span');
                      label.textContent = dataset.label;

                      legendItem.appendChild(colorBox);
                      legendItem.appendChild(label);
                      legendContainer.appendChild(legendItem);
                    });
            }

      // Random color generator for datasets
      function getRandomColor() {
              const letters = '0123456789ABCDEF';
              let color = '#';
              for (let i = 0; i < 6; i++) {
                      color += letters[Math.floor(Math.random() * 16)];
                    }
              return color;
            }

      function otherGraphs(climateData)
      {
              // Total Rainfall and Average Temperature Data
              const rainfallData = Object.keys(climateData).map(year => climateData[year].rainfall.reduce((a, b) => a + b, 0));
              const temperatureData = Object.keys(climateData).map(year => average(climateData[year].temperature));

              // Create Rainfall Chart
              const ctxRainfall = document.getElementById('rainfallChart').getContext('2d');
              const rainfallChart = new Chart(ctxRainfall, {
                      type: 'bar',
                      data: {
                              labels: Object.keys(climateData),
                              datasets: [{
                                      label: 'Total Rainfall (mm)',
                                      data: rainfallData,
                                      backgroundColor: '#007bff',
                                      borderColor: '#0056b3',
                                      borderWidth: 1,
                                      hoverBackgroundColor: '#0056b3',
                                      hoverBorderColor: '#004080'
                                    }]
                            },
                      options: {
                              responsive: true,
                              scales: {
                                      y: {
                                              beginAtZero: true,
                                              title: {
                                                      display: true,
                                                      text: 'Rainfall (mm)',
                                                      font: { weight: 'bold' },
                                                    }
                                            },
                                      x: {
                                              title: {
                                                      display: true,
                                                      text: 'Year',
                                                      font: { weight: 'bold' },
                                                    }
                                            }
                                    },
                              plugins: {
                                      tooltip: {
                                              callbacks: {
                                                      label: function(context) {
                                                              return context.dataset.label + ': ' + context.raw + ' mm';
                                                            }
                                                    }
                                            }
                                    }
                            }
                    });

              // Create Temperature Chart
              const ctxTemperature = document.getElementById('temperatureChart').getContext('2d');
              const temperatureChart = new Chart(ctxTemperature, {
                      type: 'line',
                      data: {
                              labels: Object.keys(climateData),
                              datasets: [{
                                      label: 'Average Temperature (°C)',
                                      data: temperatureData,
                                      fill: false,
                                      borderColor: '#dc3545',
                                      tension: 0.5,
                                    }]
                            },
                      options: {
                              responsive: true,
                              scales: {
                                      y: {
                                              title: {
                                                      display: true,
                                                      text: 'Temperature (°C)',
                                                      font: { weight: 'bold' },
                                                    }
                                            },
                                      x: {
                                              title: {
                                                      display: true,
                                                      text: 'Year',
                                                      font: { weight: 'bold' },
                                                    }
                                            }
                                    }
                            }
                    });
            }

      // Helper Functions
      function average(arr) {
              return arr.reduce((a, b) => a + b, 0) / arr.length;
            }

    </script>
  </body>
</html>
